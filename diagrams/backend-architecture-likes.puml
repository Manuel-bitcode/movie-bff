@startuml Backend Architecture - Movie BFF con Sistema de Likes
!define RECTANGLE class

skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle

' Estilos
skinparam component {
    BackgroundColor<<external>> #E3F2FD
    BackgroundColor<<controller>> #C8E6C9
    BackgroundColor<<service>> #FFF9C4
    BackgroundColor<<model>> #FFCCBC
    BackgroundColor<<middleware>> #F8BBD0
    BackgroundColor<<route>> #B2DFDB
    BackgroundColor<<database>> #D1C4E9
    BorderColor #424242
    FontSize 12
}

title Arquitectura Backend - Movie BFF con Sistema de Likes\n(Issue #2 - Implementado)

' Cliente
actor Cliente as client

' Capa de Entrada
package "ğŸŒ Entry Point" {
    [server.ts] as server <<entry>>
    [app.ts] as app <<config>>
}

' Middlewares
package "ğŸ”§ Middlewares" {
    [logger] <<middleware>>
    [validateImdbId] <<middleware>>
    [cors] <<middleware>>
    [error handler] <<middleware>>
}

' Rutas
package "ğŸ›£ï¸ Routes Layer" {
    [healthRoutes] <<route>>
    [movieRoutes] <<route>>
    [likesTotalRoutes] <<route>>
}

' Controladores
package "ğŸ® Controllers Layer" {
    [movieController] <<controller>>
    [likeController] <<controller>>
}

' Modelos
package "ğŸ“¦ Models Layer" {
    [likeModel] <<model>>
}

' ConfiguraciÃ³n
package "âš™ï¸ Configuration" {
    [config.ts] <<service>>
    [database.ts] <<service>>
}

' Base de datos
database "ğŸ—„ï¸ PostgreSQL" {
    [movie_likes\ntable] <<database>>
}

' API Externa
cloud "ğŸŒ External API" {
    [OMDB API] <<external>>
}

' Tipos
package "ğŸ“‹ Types" {
    [movie.types.ts] <<model>>
}

' === FLUJO DE DATOS ===

' Cliente -> Entry Point
client --> server : HTTP Request

' Entry Point -> App
server --> app : Initialize

' App -> Middlewares
app --> cors : Enable CORS
app --> logger : Log requests
app --> validateImdbId : Validate imdbId
app --> [error handler] : Handle errors

' App -> Routes
app --> healthRoutes : /health
app --> movieRoutes : /api/movies
app --> likesTotalRoutes : /api/likes

' Routes -> Controllers
healthRoutes --> movieController : Health check
movieRoutes --> movieController : GET /\nGET /:id
movieRoutes --> likeController : GET /:id/likes\nPOST /:id/like
likesTotalRoutes --> likeController : GET /total

' Controllers -> Models
likeController --> likeModel : getLikesCount()\nincrementLike()\ngetTotalLikes()

' Controllers -> External API
movieController --> [OMDB API] : Fetch movie data

' Models -> Database
likeModel --> database.ts : Connection pool
database.ts --> [movie_likes\ntable] : SQL queries

' Configuration
config.ts --> database.ts : DB credentials
database.ts ..> [movie_likes\ntable] : CRUD operations

' Types usage
movieController ..> movie.types.ts : Movie\nApiResponse
likeController ..> movie.types.ts : LikeResponse\nTotalLikesResponse

' === NOTAS ===

note right of movieRoutes
  **Endpoints:**
  â€¢ GET / - Lista todas las pelÃ­culas
  â€¢ GET /:id - Detalle de pelÃ­cula
  â€¢ GET /:id/likes - Likes de pelÃ­cula
  â€¢ POST /:id/like - Incrementar like
end note

note right of likesTotalRoutes
  **Endpoint:**
  â€¢ GET /total - Total de likes global
end note

note right of likeModel
  **Operaciones:**
  â€¢ getLikesCount(imdbId)
  â€¢ incrementLike(imdbId)
  â€¢ getTotalLikes()
  
  **SQL Operations:**
  â€¢ SELECT likes WHERE imdb_id
  â€¢ INSERT ... ON CONFLICT DO UPDATE
  â€¢ SELECT SUM(likes)
end note

note right of [movie_likes\ntable]
  **Schema:**
  â€¢ imdb_id VARCHAR(20) PK
  â€¢ likes INTEGER DEFAULT 0
  â€¢ created_at TIMESTAMP
  â€¢ updated_at TIMESTAMP
  
  **Constraints:**
  â€¢ likes >= 0 (CHECK)
  â€¢ UNIQUE(imdb_id)
end note

note right of database.ts
  **Features:**
  â€¢ Dynamic host detection
  â€¢ Docker / Local support
  â€¢ Connection pooling
  â€¢ Health checks
  
  **Environment:**
  â€¢ DOCKER_ENV=true â†’ postgres:5432
  â€¢ DOCKER_ENV=false â†’ localhost:5433
end note

note right of validateImdbId
  **Validation:**
  â€¢ Format: tt + 7+ digits
  â€¢ Example: tt0111161
  â€¢ Returns 400 if invalid
end note

note bottom of app
  **ConfiguraciÃ³n:**
  â€¢ CORS: Enabled (*)
  â€¢ Body Parser: JSON + URLEncoded
  â€¢ Logger: Custom middleware
  â€¢ Error Handler: Centralized
  â€¢ 404 Handler: Route not found
end note

' === LEYENDA ===

legend right
  |= Color |= Component Type |
  | <back:#E3F2FD>   </back> | External Services |
  | <back:#C8E6C9>   </back> | Controllers |
  | <back:#FFF9C4>   </back> | Services/Config |
  | <back:#FFCCBC>   </back> | Models |
  | <back:#F8BBD0>   </back> | Middlewares |
  | <back:#B2DFDB>   </back> | Routes |
  | <back:#D1C4E9>   </back> | Database |
  
  **TecnologÃ­as:**
  â€¢ Node.js v20.12.2
  â€¢ Express.js 5.1.0
  â€¢ TypeScript 5.7.2
  â€¢ PostgreSQL 16 Alpine
  â€¢ Docker Compose
endlegend

@enduml
